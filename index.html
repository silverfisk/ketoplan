<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Keto Planerare ‚Äì 4 veckor</title>
  <meta name="description" content="Generera 4‚Äëveckors keto‚Äëmatplaner med valbara preferenser." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print { .no-print { display:none !important; } .print-break { page-break-before: always; } }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <header class="no-print sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-bold tracking-tight">ü•ë Keto-Planeraren</h1>
      <div class="text-sm text-slate-600">Glutenfritt ¬∑ Mild mat ¬∑ 12‚Äì14 h fasta</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="mb-6">
      <div class="rounded-2xl bg-white shadow-sm border border-slate-200 p-5">
        <p class="text-slate-700">V√§lj preferenser och klicka <span class="font-semibold">Generera plan</span> f√∂r en komplett 4‚Äëveckors meny med frukost, lunch och middag.</p>
      </div>
    </section>

    <section class="no-print grid md:grid-cols-3 gap-4 mb-6">
      <div class="rounded-2xl bg-white shadow-sm border border-slate-200 p-5">
        <h2 class="font-semibold mb-3">Protein & huvudval</h2>
        <div class="grid grid-cols-2 gap-2 text-sm" id="pref-proteins"></div>
        <div class="mt-3 text-xs text-slate-600">Tips: v√§lj 4‚Äì6 favoriter f√∂r b√§st variation.</div>
      </div>

      <div class="rounded-2xl bg-white shadow-sm border border-slate-200 p-5">
        <h2 class="font-semibold mb-3">Stil & begr√§nsningar</h2>
        <div class="space-y-2 text-sm">
          <label class="flex items-center gap-2"><input id="glutenFree" type="checkbox" class="accent-slate-900" checked disabled><span>Glutenfritt (alltid)</span></label>
          <label class="flex items-center gap-2"><input id="mild" type="checkbox" class="accent-slate-900" checked><span>Milda smaker (ingen stark mat)</span></label>
          <label class="flex items-center gap-2"><input id="noMushroom" type="checkbox" class="accent-slate-900" checked><span>Uteslut svamp</span></label>
          <label class="flex items-center gap-2"><input id="allowDairy" type="checkbox" class="accent-slate-900" checked><span>Till√•t mejeri (sm√∂r, ost, gr√§dde)</span></label>
          <label class="flex items-center gap-2"><input id="cheatSushi" type="checkbox" class="accent-slate-900" checked><span>Planera 1 sushi‚Äëkv√§ll/vecka ("fusk")</span></label>
          <label class="flex items-center gap-2"><input id="budgetBias" type="checkbox" class="accent-slate-900"><span>Prioritera budgetv√§nligt</span></label>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium mb-1" for="fasting">Fasta (m√•l):</label>
            <select id="fasting" class="w-full rounded-xl border-slate-300 text-sm">
              <option value="12">12 timmar</option>
              <option value="13">13 timmar</option>
              <option value="14" selected>14 timmar</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="maxCarbs">Max kolhydrater/portion:</label>
            <select id="maxCarbs" class="w-full rounded-xl border-slate-300 text-sm">
              <option value="999" selected>Ingen gr√§ns</option>
              <option value="10">‚â§ 10 g</option>
              <option value="6">‚â§ 6 g</option>
              <option value="3">‚â§ 3 g</option>
            </select>
          </div>
        </div>
      </div>

      <div class="rounded-2xl bg-white shadow-sm border border-slate-200 p-5 flex flex-col justify-between">
        <div>
          <h2 class="font-semibold mb-3">√Ötg√§rder</h2>
          <div class="flex flex-wrap gap-2">
            <button id="btn-generate" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">Generera plan</button>
            <button id="btn-print" class="px-4 py-2 rounded-xl border text-sm hover:bg-slate-100">Skriv ut</button>
            <button id="btn-export" class="px-4 py-2 rounded-xl border text-sm hover:bg-slate-100">Exportera Markdown</button>
          </div>
        </div>
        <p class="mt-4 text-xs text-slate-600">Obs: Planen √§r generell och ers√§tter inte medicinsk r√•dgivning. Anpassa portioner efter hunger och m√•l.</p>
      </div>
    </section>

    <section id="plan" class="space-y-6"></section>

    <section class="mt-10">
      <h2 class="text-lg font-semibold mb-3">Receptkatalog</h2>
      <p class="text-sm text-slate-600 mb-4">Alla recept √§r <span class="font-medium">keto</span> och <span class="font-medium">glutenfria</span>. Klicka p√• r√§tter i planen f√∂r detaljer.</p>
      <div id="recipes-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>
  </main>

  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 p-4">
    <div class="bg-white rounded-2xl max-w-xl w-full shadow-xl border border-slate-200">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="modal-title" class="text-lg font-semibold">Recept</h3>
        <button id="modal-close" class="text-slate-500 hover:text-slate-800">‚úï</button>
      </div>
      <div class="p-4 space-y-2 text-sm" id="modal-body"></div>
      <div class="p-4 pt-0 flex items-center justify-between text-xs text-slate-600" id="modal-meta"></div>
      <div class="p-4 pt-0">
        <button id="modal-print" class="px-4 py-2 rounded-xl border text-sm hover:bg-slate-50">Skriv ut recept</button>
      </div>
    </div>
  </div>

  <script>
    const PROTEINS = [
      {key:'egg', label:'√Ñgg'}, {key:'bacon', label:'Bacon'}, {key:'chicken', label:'Kyckling'},
      {key:'salmon', label:'Lax'}, {key:'whitefish', label:'Vit fisk (torsk/sej)'}, {key:'beef', label:'N√∂tk√∂tt'},
      {key:'pork', label:'Fl√§sk'}, {key:'halloumi', label:'Halloumi'}, {key:'veg', label:'Vegetariskt'},
      {key:'fish', label:'Fisk (√∂vrig)'}, {key:'seafood', label:'Skaldjur'}
    ];

    const elProteins = document.getElementById('pref-proteins');
    PROTEINS.forEach(p => {
      const id = 'p_' + p.key;
      const div = document.createElement('label');
      div.className = 'flex items-center gap-2';
      const checkedByDefault = ['egg','chicken','salmon','halloumi','bacon'].includes(p.key);
      div.innerHTML = `<input type="checkbox" id="${id}" class="accent-slate-900" ${checkedByDefault?'checked':''}><span>${p.label}</span>`;
      elProteins.appendChild(div);
    });

    const qs = (s) => document.querySelector(s);
    const qsa = (s) => Array.from(document.querySelectorAll(s));

    let RECIPES = [];

    async function loadRecipes(){
      try{
        const res = await fetch('recipes.json', {cache:'no-store'});
        if(!res.ok) throw new Error('Fel vid laddning av recipes.json');
        const data = await res.json();
        RECIPES = data.recipes || [];
        renderRecipes();
      }catch(err){
        console.error(err);
        alert('Kunde inte l√§sa recipes.json. Kontrollera filens placering/namn och CORS.');
      }
    }

    function getPrefs(){
      const proteins = PROTEINS.filter(p => qs('#p_'+p.key).checked).map(p=>p.key);
      return {
        proteins,
        mild: qs('#mild').checked,
        noMushroom: qs('#noMushroom').checked,
        allowDairy: qs('#allowDairy').checked,
        cheatSushi: qs('#cheatSushi').checked,
        budgetBias: qs('#budgetBias').checked,
        fasting: Number(qs('#fasting').value),
        maxCarbs: Number(qs('#maxCarbs').value)
      };
    }

    function matchesPrefs(recipe, prefs){
      if(!prefs.allowDairy){
        const txt = (recipe.ingredients || []).join(' ').toLowerCase();
        if(txt.includes('ost') || txt.includes('gr√§d') || txt.includes('sm√∂r') || txt.includes('creme fraiche') || txt.includes('cr√®me fra√Æche')) return false;
      }
      if(prefs.mild && (recipe.tags || []).includes('spicy')) return false;
      if(prefs.budgetBias && recipe.cheap === false) return false;
      if(prefs.maxCarbs < 999 && (recipe.carbs ?? 999) > prefs.maxCarbs) return false;
      const ing = (recipe.ingredients || []).join(' ').toLowerCase();
      if(prefs.noMushroom && ing.includes('svamp')) return false;
      const proteinTags = (recipe.tags || []).filter(t=>['egg','bacon','chicken','salmon','whitefish','beef','pork','halloumi','veg','fish','seafood'].includes(t));
      if(prefs.proteins.length){
        const ok = proteinTags.some(t=>prefs.proteins.includes(t)) || (prefs.proteins.includes('veg') && proteinTags.includes('veg'));
        if(!ok) return false;
      }
      return true;
    }

    function pick(list, usedIds){
      const candidates = list.filter(r=>!usedIds.has(r.id));
      if(!candidates.length) { usedIds.clear(); return list[Math.floor(Math.random()*list.length)]; }
      return candidates[Math.floor(Math.random()*candidates.length)];
    }

    function generatePlan(){
      const prefs = getPrefs();
      const breakfasts = RECIPES.filter(r=>r.meal==='breakfast' && matchesPrefs(r,prefs));
      const lunches = RECIPES.filter(r=>r.meal==='lunch' && matchesPrefs(r,prefs));
      let dinners = RECIPES.filter(r=>r.meal==='dinner' && matchesPrefs(r,prefs));
      const sushi = RECIPES.find(r=>r.id==='x1');
      if(prefs.cheatSushi && sushi) dinners = dinners.concat([sushi]);

      if(!breakfasts.length || !lunches.length || !dinners.length){
        alert('F√∂r f√• recept matchar dina val. Avmarkera n√•gra filter eller l√§gg till fler recept.');
        return;
      }

      const weeks = [];
      const usedB = new Set(), usedL = new Set(), usedD = new Set();
      for(let w=0; w<4; w++){
        const days = [];
        for(let d=0; d<7; d++){
          const b = pick(breakfasts, usedB); usedB.add(b.id);
          const l = pick(lunches, usedL); usedL.add(l.id);
          const dd = pick(dinners, usedD); usedD.add(dd.id);
          days.push({b,l,d:dd});
        }
        weeks.push(days);
      }
      renderPlan(weeks, prefs);
      window.scrollTo({top: document.getElementById('plan').offsetTop - 8, behavior:'smooth'});
    }

    function renderPlan(weeks, prefs){
      const host = document.getElementById('plan');
      host.innerHTML = '';
      weeks.forEach((days, wi) => {
        const card = document.createElement('div');
        card.className = 'rounded-2xl bg-white shadow-sm border border-slate-200 overflow-hidden';
        const header = document.createElement('div');
        header.className = 'px-5 py-3 border-b flex items-center justify-between bg-slate-50';
        header.innerHTML = `<div class="font-semibold">Vecka ${wi+1}</div><div class="text-sm text-slate-600">Fasta: ${prefs.fasting} h ¬∑ Mild mat</div>`;
        const body = document.createElement('div'); body.className = 'p-0';

        const table = document.createElement('table'); table.className = 'w-full text-sm';
        table.innerHTML = `<thead class="bg-slate-100 text-slate-700"><tr><th class="text-left p-3">Dag</th><th class="text-left p-3">Frukost (kl. 9)</th><th class="text-left p-3">Lunch (kl. 13)</th><th class="text-left p-3">Middag (kl. 18‚Äì19)</th></tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');

        const dayNames = ['M√•n','Tis','Ons','Tor','Fre','L√∂r','S√∂n'];
        days.forEach((row, di) => {
          const tr = document.createElement('tr');
          tr.className = di % 2 ? 'bg-white' : 'bg-slate-50/50';
          tr.innerHTML = `
            <td class="p-3 font-medium">${dayNames[di]}</td>
            <td class="p-3"><button class="underline decoration-dotted hover:no-underline" data-id="${row.b.id}">${row.b.name}</button></td>
            <td class="p-3"><button class="underline decoration-dotted hover:no-underline" data-id="${row.l.id}">${row.l.name}</button></td>
            <td class="p-3"><button class="underline decoration-dotted hover:no-underline" data-id="${row.d.id}">${row.d.name}</button></td>`;
          tbody.appendChild(tr);
        });

        body.appendChild(table);
        card.appendChild(header); card.appendChild(body);
        host.appendChild(card);
      });

      qsa('#plan button[data-id]').forEach(btn => btn.addEventListener('click', () => openRecipe(btn.dataset.id)));
    }

    function recipeToHTML(r){
      const meta = r.meta || {};
      const allergenList = (meta.allergens||[]).join(', ');
      return `
        <div class="text-xs text-slate-600">${r.meal==='breakfast' ? 'Frukost' : r.meal==='lunch' ? 'Lunch' : (r.tags||[]).includes('cheat')?'Fusk':'Middag'}</div>
        <h4 class="text-base font-semibold">${r.name}</h4>
        <div class="text-xs text-slate-600">Kolhydrater (‚âà): ${r.carbs ?? '‚Äì'} g/portion ¬∑ ${r.cheap? 'Budgetv√§nlig' : 'Standard'}</div>
        <div class="text-xs text-slate-600">Tillagningstid: ${meta.time_minutes ?? '‚Äì'} min ¬∑ Portioner: ${meta.servings ?? '‚Äì'} ¬∑ Sv√•righet: ${meta.skill_level ?? '‚Äì'}</div>
        <div class="text-xs text-slate-600">K√∂k: ${meta.cuisine ?? '‚Äì'} ¬∑ Protein: ${meta.protein ?? '‚Äì'} ${allergenList ? '¬∑ Allergener: ' + allergenList : ''}</div>
        <div class="mt-2">
          <div class="font-medium">Ingredienser</div>
          <ul class="list-disc pl-5 text-sm">${(r.ingredients||[]).map(i=>`<li>${i}</li>`).join('')}</ul>
        </div>
        <div class="mt-2">
          <div class="font-medium">G√∂r s√• h√§r</div>
          <ol class="list-decimal pl-5 text-sm">${(r.steps||[]).map(s=>`<li>${s}</li>`).join('')}</ol>
        </div>`;
    }

    function openRecipe(id){
      const r = RECIPES.find(x=>x.id===id);
      if(!r) return;
      qs('#modal-title').textContent = r.name;
      qs('#modal-body').innerHTML = recipeToHTML(r);
      const meta = r.meta || {};
      qs('#modal-meta').innerHTML = `
        <div>${meta.source_name ? ('K√§lla: ' + meta.source_name) : ''} ${meta.source_url ? ' ¬∑ <a class="underline" href="${meta.source_url}" target="_blank" rel="noopener">√ñppna k√§lla</a>' : ''}</div>
        <div>${(r.tags||[]).map(t=>`<span class="inline-block text-[11px] px-2 py-1 bg-slate-100 border rounded-full mr-1">${t}</span>`).join('')}</div>`;
      qs('#modal').classList.remove('hidden'); qs('#modal').classList.add('flex');
    }
    function closeModal(){ qs('#modal').classList.add('hidden'); qs('#modal').classList.remove('flex'); }

    function renderRecipes(){
      const host = document.getElementById('recipes-grid');
      host.innerHTML = '';
      RECIPES.forEach(r => {
        const card = document.createElement('div'); card.className = 'rounded-2xl bg-white shadow-sm border border-slate-200 p-4 flex flex-col';
        card.innerHTML = `
          <div class="text-xs text-slate-600 mb-1">${r.meal==='breakfast' ? 'Frukost' : r.meal==='lunch' ? 'Lunch' : ((r.tags||[]).includes('cheat')?'Fusk':'Middag')}</div>
          <h3 class="font-semibold">${r.name}</h3>
          <div class="text-xs text-slate-600">Kolhydrater (‚âà): ${r.carbs ?? '‚Äì'} g ¬∑ ${r.cheap? 'Budget' : 'Standard'}</div>
          <div class="mt-2 flex-1 text-sm line-clamp-3">${(r.ingredients||[]).slice(0,3).join(', ')}...</div>
          <div class="mt-3"><button data-id="${r.id}" class="text-sm underline decoration-dotted">Visa recept</button></div>`;
        host.appendChild(card);
      });
      qsa('#recipes-grid button[data-id]').forEach(btn => btn.addEventListener('click', () => openRecipe(btn.dataset.id)));
    }

    function exportMarkdown(){
      const blocks = [];
      const weeks = qsa('#plan > div');
      weeks.forEach((w, i) => {
        blocks.push(`## Vecka ${i+1}`);
        const rows = w.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const tds = row.querySelectorAll('td');
          blocks.push(`- **${tds[0].innerText}**: Frukost ‚Äì ${tds[1].innerText}; Lunch ‚Äì ${tds[2].innerText}; Middag ‚Äì ${tds[3].innerText}`);
        });
      });
      const blob = new Blob([`# 4‚Äëveckors keto‚Äëplan\n\n${blocks.join('\n')}`],{type:'text/markdown'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'keto-plan-4-veckor.md'; a.click(); URL.revokeObjectURL(url);
    }

    document.getElementById('btn-generate').addEventListener('click', generatePlan);
    document.getElementById('btn-print').addEventListener('click', () => window.print());
    document.getElementById('btn-export').addEventListener('click', exportMarkdown);
    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-print').addEventListener('click', () => window.print());
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // Boot
    loadRecipes();
  </script>
</body>
</html>
